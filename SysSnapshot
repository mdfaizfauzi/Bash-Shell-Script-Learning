#!/bin/bash
# SysSnapshot: Linux System Monitoring & Backup Utility
# Author: Faiz Fauzi
# Date: 28/11/2025
# Version: 1.0

# --- Configuration Variables ---
BACKUP_SOURCE="/home/$USER/Assignment1_starter_templatev2"
BACKUP_DEST="/home/$USER/Assignment1_starter_templatev2/backups"
REPORTS_DIR="/home/$USER/Assignment1_starter_templatev2/reports"
LAST_BACKUP_REF_FILE="$BACKUP_DEST/.last_backup_ref"

# Create directories if they don't exist
mkdir -p "$BACKUP_DEST" 2>/dev/null
mkdir -p "$REPORTS_DIR" 2>/dev/null

# --- Utility Function ---
separator() {
    echo "----------------------------------------"
}

# --- Password Prompt ---
read -s -p "Enter sudo password: " SUDO_PASS
echo  # newline after password

# ---------------------------------------------------------------------
# Feature 1: System Health and User Activity Monitoring
# ---------------------------------------------------------------------

# Function 1.1: Monitor CPU, memory, and disk usage
check_system_resources() {
    clear
    echo "=== 1. Check System Resources ==="

    # 1. Display current CPU load average (1, 5, 15 minutes)
    echo "--- CPU Load ---"
    uptime | awk '{print "Load average: " $1 " " $2 " " $3}' 2>/dev/null || echo "Unable to retrieve CPU load."

    separator

    # 2. Show memory usage (total, used, free, percentage)
    echo "--- Memory Usage ---"
    free -m | grep "Mem" | awk '{total=$2; used=$3; free=$4; perc=int(used*100/total); print "Total: " total "MB, Used: " used "MB, Free: " free "MB, Usage: " perc "%" }' 2>/dev/null || echo "Memory usage not available."

    separator

    # 3. Display disk usage for root partition (/)
    echo "--- Disk Usage (/) ---"
    df -h / 2>/dev/null | grep "^/dev/" | awk '{print "Device: " $1 ", Size: " $2 ", Used: " $3 ", Available: " $4 ", Use%: " $5}' 2>/dev/null || echo "Disk usage not available."

    separator
}

# Function 1.2: Track User Activity & Sessions
track_user_activity() {
    clear
    echo "=== 2. Track User Activity & Sessions ==="

    # 1. List all currently logged-in users and details
    echo "--- Active Sessions ---"
    who 2>/dev/null | awk '{print "User: " $1 ", Terminal: " $2 ", Login Time: " $3}' 2>/dev/null || echo "No active sessions found."

    separator

    # 2. Count total active sessions
	echo "Total Active Sessions: $(who | wc -l 2>/dev/null || echo "0")"

    separator

    # 3. Identify users with multiple sessions
    echo "--- Users with Multiple Sessions ---"
    who | awk '{print $1}' | sort | uniq -c | awk '{if($1>1) print $2 " (" $1 " sessions)"}' 2>/dev/null || echo "No users with multiple sessions."

}

# ---------------------------------------------------------------------
# Feature 2: Incremental Backup Management
# ---------------------------------------------------------------------

# Function 2.1: Create Incremental Backup
create_incremental_backup() {
    clear
    echo "=== 3. Create Incremental Backup ==="

    # Validate source directory
    if [ ! -d "$BACKUP_SOURCE" ]; then
        echo "Error: Source directory $BACKUP_SOURCE not found. Skipping."
        return 1
    fi

    # Get timestamp
    TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
    CURRENT_BACKUP_DIR="$BACKUP_DEST/$(basename $BACKUP_SOURCE)_$TIMESTAMP"

    # Check for reference file
    if [ -f "$LAST_BACKUP_REF_FILE" ]; then
        echo "Performing Incremental Backup. Reference: $LAST_BACKUP_REF_FILE"
        FILES_TO_BACKUP=$(find "$BACKUP_SOURCE" -type f -newer "$LAST_BACKUP_REF_FILE" 2>/dev/null)
    else
        echo "Performing Full Backup (No previous reference found)."
        FILES_TO_BACKUP=$(find "$BACKUP_SOURCE" -type f 2>/dev/null)
    fi

    # Check if any files to backup
    if [ -z "$FILES_TO_BACKUP" ]; then
        echo "No files to backup. Skipping."
        return 0
    fi

    # Create backup directory
    mkdir -p "$CURRENT_BACKUP_DIR"

    # Copy files
    echo "Copying files to $CURRENT_BACKUP_DIR..."
    echo "$FILES_TO_BACKUP" | xargs -I {} rsync -R {} "$CURRENT_BACKUP_DIR/" 2>/dev/null

    # Calculate size
    SIZE=$(du -sh "$CURRENT_BACKUP_DIR" 2>/dev/null | cut -f1)
    FILE_COUNT=$(echo "$FILES_TO_BACKUP" | wc -l)

    echo "--- Backup Summary ---"
    echo "Files backed up: $FILE_COUNT"
    echo "Total size: $SIZE"
    echo "Backup completed successfully."

    # Update reference file
    touch "$LAST_BACKUP_REF_FILE"

    return 0
}

# Function 2.2: Verify Backup Integrity
verify_backup_integrity() {
    clear
    echo "=== 4. Verify Backup Integrity ==="

    # Find latest backup
    LATEST_BACKUP_DIR=$(find "$BACKUP_DEST" -maxdepth 1 -type d -name "$(basename $BACKUP_SOURCE)_*" | sort -r | head -n 1)

    if [ -z "$LATEST_BACKUP_DIR" ]; then
        echo "Verification FAILED: No backup directory found."
        return 1
    fi

    # Count source files
    SOURCE_COUNT=$(find "$BACKUP_SOURCE" -type f | wc -l 2>/dev/null || echo 0)
    BACKUP_COUNT=$(find "$LATEST_BACKUP_DIR" -type f | wc -l 2>/dev/null || echo 0)

    echo "Source files: $SOURCE_COUNT"
    echo "Backup files: $BACKUP_COUNT"

    # Compare counts
    if [ "$SOURCE_COUNT" -eq "$BACKUP_COUNT" ]; then
        echo "Status: PASS"
        echo "Verification complete."
        return 0
    else
        echo "Status: FAIL (File count mismatch)"
        return 1
    fi
}

# ---------------------------------------------------------------------
# Feature 3: Filesystem Usage and Process Reporting
# ---------------------------------------------------------------------

# Function 3.1: Generate Filesystem Usage Report
generate_filesystem_report() {
    clear
    echo "=== 5. Generate Filesystem Usage Report ==="
    echo "Generated: $(date +%Y-%m-%d\ %H:%M)"

    # Define report file
    REPORT_FILE="$REPORTS_DIR/FileSystem_Report_$(date +%Y%m%d_%H%M%S).txt"

    # Create report file
    {
        echo "=== Filesystem Usage Report ==="
        echo "Generated: $(date +%Y-%m-%d\ %H:%M)"
        echo "========================================"
        separator

        # Top 10 largest directories (limited to /home and /var to avoid system-wide scan)
        echo "--- Top 10 Largest Directories ---"
        du -sh /home /var /usr 2>/dev/null | sort -rh | head -n 11 | awk '{print "    " $0}' | sed 's/^/    /'

        separator

        # Filesystem usage by type (limited to mounted filesystems)
        echo "--- Filesystem Usage by Type ---"
        df -T -h 2>/dev/null | grep -v "^Filesystem" | awk '{print "    Device: " $1 ", Type: " $2 ", Size: " $3 ", Used: " $4 ", Use%: " $5}' | sed 's/^/    /'

        separator

        # Directory with most files (limited to /home to avoid system-wide scan)
        echo "--- Directory with Most Files ---"
        find /home -maxdepth 2 -type d -name "*" | xargs -I {} du -sh {} 2>/dev/null | sort -rh | head -n 1 | awk '{print "    Directory: " $1 ", Size: " $2}' | sed 's/^/    /'

        separator
    } > "$REPORT_FILE"

    echo "Report saved to: $REPORT_FILE"
    cat "$REPORT_FILE"
}

# Function 3.2: Analyze Running Processes
analyze_running_processes() {
    clear
    echo "=== 6. Analyze Running Processes ==="

    # Top 10 by CPU
    echo "--- Top 10 by CPU Usage ---"
    ps aux --sort=-%cpu | head -n 11 | awk '{print $1 " " $2 " " $3 " " $4 " " $5 " " $6 " " $7 " " $8 " " $9 " " $10}' | sed 's/^/    /'

    separator

    # Top 10 by Memory
    echo "--- Top 10 by Memory Usage ---"
    ps aux --sort=-%mem | head -n 11 | awk '{print $1 " " $2 " " $3 " " $4 " " $5 " " $6 " " $7 " " $8 " " $9 " " $10}' | sed 's/^/    /'

    separator

    # Process states
    echo "--- Process States ---"
    ps aux | awk '{print $8}' | sort | uniq -c | awk '{print $1 " " $2}' | sed 's/^/    /'

    separator

    # Long-running processes (>24h)
    echo "--- Long-running (>24h) Processes ---"
    ps aux --sort=-etime | awk -v hour=24 '{if($7 ~ /-/ && $7 ~ /day/) print $0}' | sed 's/^/    /'

    separator
}

# ---------------------------------------------------------------------
# Main Menu Loop
# ---------------------------------------------------------------------

display_menu() {
    clear
    echo -e "\e[1;35m"
    echo "┌────────────────────────────────────────────────────────────┐"
    echo "│               LINUX SYSTEM MONITORING & BACKUP UTILITY     │"
    echo "│                       Version 1.0                          │"
    echo "└────────────────────────────────────────────────────────────┘"
    echo -e "\e[0m"

    echo -e "\e[1;36m"
    echo "┌────────────────────────────────────────────────────────────┐"
    echo "│               SYSTEM HEALTH & USER ACTIVITY                │"
    echo "├────────────────────────────────────────────────────────────┤"
    echo "│  1) Check System Resources (CPU, Memory, Disk)             │"
    echo "│  2) Track User Activity & Sessions                         │"
    echo "└────────────────────────────────────────────────────────────┘"
    echo -e "\e[0m"

    echo -e "\e[1;33m"
    echo "┌────────────────────────────────────────────────────────────┐"
    echo "│                       BACKUP MANAGEMENT                    │"
    echo "├────────────────────────────────────────────────────────────┤"
    echo "│  3) Create Incremental Backup                              │"
    echo "│  4) Verify Backup Integrity                                │"
    echo "└────────────────────────────────────────────────────────────┘"
    echo -e "\e[0m"

    echo -e "\e[1;32m"
    echo "┌────────────────────────────────────────────────────────────┐"
    echo "│                      REPORTING & ANALYSIS                  │"
    echo "├────────────────────────────────────────────────────────────┤"
    echo "│  5) Generate Filesystem Usage Report                       │"
    echo "│  6) Analyze Running Processes                              │"
    echo "└────────────────────────────────────────────────────────────┘"
    echo -e "\e[0m"

    echo -e "\e[1;31m"
    echo "┌────────────────────────────────────────────────────────────┐"
    echo "│                        0) Exit                             │"
    echo "└────────────────────────────────────────────────────────────┘"
    echo -e "\e[0m"

    echo -e "\e[1;35m"
    echo "========================================"
    echo " Enter choice (0-6): "
    echo -e "\e[0m"
}

main_loop() {
    while true; do
        display_menu
        read choice

        case $choice in
            1) check_system_resources ;;
            2) track_user_activity ;;
            3) create_incremental_backup ;;
            4) verify_backup_integrity ;;
            5) generate_filesystem_report ;;
            6) analyze_running_processes ;;
            0) echo "Exiting SysSnapshot. Goodbye!"; exit 0 ;;
            *) echo "Invalid option. Please enter a number between 0 and 6." ;;
        esac
        echo
        echo "Press [Enter] to continue..."
        read -r
    done
}

# Execute main loop
main_loop
